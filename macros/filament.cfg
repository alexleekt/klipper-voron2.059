[gcode_macro SERVICE_EXTRUDE]
default_parameter_MINTEMP=220
default_parameter_DISTANCE=100
default_parameter_RATE=100
gcode:
    NOTIFY_ACKNOWLEDGE
    SAVE_GCODE_STATE
    {% if printer.extruder.temperature < MINTEMP and printer.extruder.target > MINTEMP|int %}
        M109 S{printer.extruder.target} ; wait for previous M104
    {% elif printer.extruder.temperature < MINTEMP %}
        M109 S{MINTEMP}               ; Wait for min E temp
    {% endif %}
    G92 E0              ; zero the extruded length
    G0 E{DISTANCE} F{RATE}    ; extrude
    RESTORE_GCODE_STATE

[gcode_macro RETRACT_FILAMENT_TO_PARK]
gcode:
    SAVE_GCODE_STATE
    M83 ; use relative distances for extrusion
    G0 E-105 F2400
    RESTORE_GCODE_STATE

[gcode_macro EXTRUDE_FILAMENT_TO_NOZZLE]
gcode:
    SAVE_GCODE_STATE
    M83 ; use relative distances for extrusion
    G0 E100 F1500
    RESTORE_GCODE_STATE

[gcode_macro MEASURE_FILAMENT]
gcode:
    service_extrude E=100

[gcode_macro LOAD_FILAMENT]
gcode:
    service_extrude E=820 F=1500

[gcode_macro UNLOAD_FILAMENT]
gcode:
    service_extrude E=-1000 F=2100
    M84 ; disable steppers

[gcode_macro NOZZLE_SCRUB]
gcode:
    SAVE_GCODE_STATE
    M117 Nozzle Scrub!
    G0 Z12 X130 Y356 F21000
    {% for wipe in range(10) %}
        {% for coordinate in [(70,356),(130,356)] %}
            G0 X{coordinate[0]} Y{coordinate[1]} F9000
        {% endfor %}
    {% endfor %}
    G0 X175 Y350 F21000
    M117
    RESTORE_GCODE_STATE
